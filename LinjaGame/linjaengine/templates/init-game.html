{% extends 'layout.html' %} {%block initgame%}
<br> {% load static %}
<div class="row">
  <div class="col s7 push-s5 center">
    <span class="flow-text">
      <div class="row inicial filaNegra1 filaRoja8" ondragover="drop(event)">
        {% csrf_token %}
        <img class="img_base filaNegra1 filaRoja8">
        <img class="img_peon" id="N1" draggable='true'  ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-negro.png' %}" width="40px" alt="Negro">
        <img class="img_peon" id="N1" draggable='true'  ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-negro.png' %}" width="40px" alt="Negro">
        <img class="img_peon" id="N1" draggable='true'  ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-negro.png' %}" width="40px" alt="Negro">
        <img class="img_peon" id="N1" draggable='true'  ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-negro.png' %}" width="40px" alt="Negro">
        <img class="img_peon" id="N1" draggable='true'  ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-negro.png' %}" width="40px" alt="Negro">
        <img class="img_peon" id="N1" draggable='true'  ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-negro.png' %}" width="40px" alt="Negro">

      </div>

      <img class="img_peon" src="{% static 'img/barra.png' %}" width="370px" height="10px" alt="">


      <div class="row filaNegra2 filaRoja7" ondragover="drop(event)" >
        <img class="img_base filaNegra2 filaRoja7">
        <img class="img_peon" id="N2" draggable='true' ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-negro.png' %}" width="40px" alt="Negro">
        <img class="img_peon" id="R7" draggable='true' ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-rojo.png' %}" width="45px" alt="Rojo">
      </div>


      <img class="img_peon" src="{% static 'img/barra.png' %}" width="370px" height="10px" alt="">

      <div class="row filaNegra3 filaRoja6" ondragover="drop(event)" >
        <img class="img_base filaNegra3 filaRoja6">
        <img class="img_peon" id="N3" draggable='true' ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-negro.png' %}" width="40px" alt="Negro">
        <img class="img_peon" id="R6" draggable='true' ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-rojo.png' %}" width="45px" alt="Rojo">
      </div>

      <img class="img_peon" src="{% static 'img/barra.png' %}" width="370px" height="10px" alt="">

      <div class="row filaNegra4 filaRoja5" ondragover="drop(event)" >
        <img class="img_base filaNegra4 filaRoja5">
        <img class="img_peon" id="N4" draggable='true' ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-negro.png' %}" width="40px" alt="Negro">
        <img class="img_peon" id="R5" draggable='true' ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-rojo.png' %}" width="45px" alt="Rojo">
      </div>

      <img class="img_peon" src="{% static 'img/barra.png' %}" width="370px" height="10px" alt="">

      <div class="row filaNegra5 filaRoja4" ondragover="drop(event)" >
        <img class="img_base filaNegra5 filaRoja4">
        <img class="img_peon" id="N5" draggable='true' ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-negro.png' %}" width="40px" alt="Negro">
        <img class="img_peon" id="R4" draggable='true' ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-rojo.png' %}" width="45px" alt="Rojo">
      </div>

      <img class="img_peon" src="{% static 'img/barra.png' %}" width="370px" height="10px" alt="">

      <div class="row filaNegra6 filaRoja3" ondragover="drop(event)" >
        <img class="img_base filaNegra5 filaRoja3">
        <img class="img_peon" id="N6" draggable='true' ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-negro.png' %}" width="40px" alt="Negro">
        <img class="img_peon" id="R3" draggable='true' ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-rojo.png' %}" width="45px" alt="Rojo">
      </div>

      <img class="img_peon" src="{% static 'img/barra.png' %}" width="370px" height="10px" alt="">

      <div class="row filaNegra7 filaRoja2" ondragover="drop(event)" >
        <img class="img_base filaNegra7 filaRoja2">
        <img class="img_peon" id="N7" draggable='true' ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-negro.png' %}" width="40px" alt="Negro">
        <img class="img_peon" id="R2" draggable='true' ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-rojo.png' %}" width="45px" alt="Rojo">
      </div>

      <img class="img_peon" src="{% static 'img/barra.png' %}" width="370px" height="10px" alt="">

      <div class="row inicial filaNegra8 filaRoja1" ondragover="drop(event)">
        <img class="img_base filaNegra8 filaRoja1">
        <img class="img_peon" id="R1" draggable='true'  ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-negro.png' %}" width="40px" alt="Negro">
        <img class="img_peon" id="R1" draggable='true'  ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-negro.png' %}" width="40px" alt="Negro">
        <img class="img_peon" id="R1" draggable='true'  ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-negro.png' %}" width="40px" alt="Negro">
        <img class="img_peon" id="R1" draggable='true'  ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-negro.png' %}" width="40px" alt="Negro">
        <img class="img_peon" id="R1" draggable='true'  ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-negro.png' %}" width="40px" alt="Negro">
        <img class="img_peon" id="R1" draggable='true'  ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-negro.png' %}" width="40px" alt="Negro">

      </div>
    </span>
  </div>

  <div class="col s5 pull-s7" style="width: 30% !important;">
    <span class="flow-text">
      <ul class="collection">
        <li class="collection-item avatar">
          <i class="material-icons circle">mood</i>
          <span class="title">Jugador Uno</span>
          <p>Movimiento: 1</p>
          <span class="title">Puntos: 8</span>

          <a href="#!" class="secondary-content"><i class="material-icons">grade</i></a>
        </li>
        <li class="collection-item avatar">
          <i class="material-icons circle">videogame_asset</i>
          <span class="title">Jugador Dos</span>
          <p>Movimiento: 1</p>
          <span class="title">Puntos: 2</span>
          <a href="#!" class="secondary-content"><i class="material-icons">grade</i></a>
        </li>
      </ul>
    </span>
  </div>
</div>
<script>
  var dragged;
  var jugadaRojo=0;
  var jugadaNegro=0;
  var boolRojo=true;
  var boolNegro=true;
  function dragIniciado(event) {
    dragged = event.target;
    event.target.style.opacity = .5;
    console.log('dragIniciado')
    //console.log(event.target.id);
  }

  function dragFinalizado(event) {
    event.target.style.opacity = "";
    evaluarMovimientos();
    //aqui post
    sendDataBack(event.target);
    console.log('dragFinalizado')
  }

  function dragEnter(event) {
    if (event.target.className == "row") {
      event.target.style.background = "yellow";
    }
  }

  function dragLeave(event) {
    if (event.target.className == "row") {
      event.target.style.background = "";
    }
  }

  function drop(event) {
    event.preventDefault();
    if (event.target.className == "row inicial filaNegra8 filaRoja1" || event.target.className ==
      "row inicial filaNegra1 filaRoja8") {
      devolverFichas(30);

    } else if (event.target.className.includes("row")) {
      devolverFichas(6);

    } else {
      console.log('No puede tener mas de 6 peones');
    }
  }
  function evaluarMovimientos(){
    if(dragged.alt == 'Rojo' && boolRojo==true){
      jugadaRojo++;
      //console.log(jugadaRojo);
      boolNegro=false;
      boolRojo = true;
      if(jugadaRojo>=2){
        jugadaRojo=0;
        boolRojo = false;
        boolNegro=true;
      }
    }
    if(dragged.alt == 'Negro' && boolNegro==true){
      jugadaNegro++;
      boolRojo=false;
      boolNegro=true;
      if(jugadaNegro>=2){
        jugadaNegro=0;
        boolRojo = true;
        boolNegro=false;
      }
    }
  }
  function devolverFichas(limite) {

    var x = event.target.innerHTML;
    var a = event.target;
    var cont = 0;
    var fila = 0;
    var posFila = 0;
    if (dragged.alt == "Negro" && boolNegro==true && jugadaNegro<=2) {

      for (var i = 0; i < x.length; i++) {
        if (x.substring(i, i + 8) == "img_peon") {
          cont++;
        }
      }

      for (var i = 0; i < x.length; i++) {
        if (x.substring(i, i + 9) == "filaNegra") {
          posFila = i;
        }
      }

      fila = x.substring(posFila + 9, posFila + 10);
      idPeon = dragged.id;
      if (cont < limite && fila >= idPeon[1]) {
        event.target.style.background = "";
        dragged.parentNode.removeChild(dragged);
        dragged.id = "N" + fila;
        event.target.appendChild(dragged);

      }
    }



    if (dragged.alt == "Rojo" && boolRojo==true && jugadaRojo<=2) {
      console.log('Rojo');

      for (var i = 0; i < x.length; i++) {
        if (x.substring(i, i + 8) == "img_peon") {
          cont++;
        }
      }

      for (var i = 0; i < x.length; i++) {
        if (x.substring(i, i + 8) == "filaRoja") {
          posFila = i;
        }
      }

      fila = x.substring(posFila + 8, posFila + 9);
      idPeon = dragged.id;
      //console.log(idPeon[1]);
      if (cont < limite && fila >= idPeon[1]) {
        event.target.style.background = "";
        dragged.parentNode.removeChild(dragged);
        dragged.id = "R" + fila;

        event.target.appendChild(dragged);
      }
    }

  }

  function sendDataBack(event1) {
    var cont =0;
    console.log(event1)
    var dataPeon = event1.outerHTML;
    var idPeon = '';
    // offsetParent  --> html tabla
    var fila = event.target.parentElement.innerHTML;
    console.log(fila.length);
    //console.log(dataPeon.length);
    for (var i = 0; i < fila.length; i++) {
      if (fila.substring(i, i + 8) == "img_peon") {
        cont++;
      }
    }

    for (var i = 0; i < dataPeon.length; i++) {
      if (dataPeon.substring(i, i + 3) == "id=") {
        idPeon = dataPeon.substring(i+4,i+6);
      }
    }
    //console.log(idPeon);
    //console.log('Hay '+cont);

    var objetoEnviar = {
      "contenido": dataPeon,
      "id": idPeon,
      "Num_Peones_Fila": cont-1,
    }
    $.post('/engine/', objetoEnviar, function (data, status) {

      var rta = JSON.parse(data)
      console.log('enviar datos a back', )

      if (rta['status'] == 1) {
        alert(rta['message'])
      }
    })
  }
</script>
<br>{%endblock%}
