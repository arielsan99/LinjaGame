{% extends 'layout.html' %} {%block initgame%}
<br> {% load static %}
<div class="row">
  <div class="col s7 push-s5 center">
    <span class="flow-text">
      <div class="row inicial filaNegra1 filaRoja8" id="N1 R8" ondragover="drop(event)">
        {% csrf_token %}
        <img class="img_base filaNegra1 filaRoja8">
        <img class="img_peon" id="N1" draggable='true'  ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-negro.png' %}" width="40px" alt="Negro">
        <img class="img_peon" id="N1" draggable='true'  ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-negro.png' %}" width="40px" alt="Negro">
        <img class="img_peon" id="N1" draggable='true'  ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-negro.png' %}" width="40px" alt="Negro">
        <img class="img_peon" id="N1" draggable='true'  ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-negro.png' %}" width="40px" alt="Negro">
        <img class="img_peon" id="N1" draggable='true'  ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-negro.png' %}" width="40px" alt="Negro">
        <img class="img_peon" id="N1" draggable='true'  ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-negro.png' %}" width="40px" alt="Negro">

      </div>

      <img class="img_peon" src="{% static 'img/barra.png' %}" width="370px" height="10px" alt="">


      <div class="row filaNegra2 filaRoja7"  id="N2 R7" ondragover="drop(event)" >
        <img class="img_base filaNegra2 filaRoja7">
        <img class="img_peon" id="N2" draggable='true' ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-negro.png' %}" width="40px" alt="Negro">
        <img class="img_peon" id="R7" draggable='true' ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-rojo.png' %}" width="45px" alt="Rojo">
      </div>


      <img class="img_peon" src="{% static 'img/barra.png' %}" width="370px" height="10px" alt="">

      <div class="row filaNegra3 filaRoja6"  id="N3 R6" ondragover="drop(event)" >
        <img class="img_base filaNegra3 filaRoja6">
        <img class="img_peon" id="N3" draggable='true' ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-negro.png' %}" width="40px" alt="Negro">
        <img class="img_peon" id="R6" draggable='true' ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-rojo.png' %}" width="45px" alt="Rojo">
      </div>

      <img class="img_peon" src="{% static 'img/barra.png' %}" width="370px" height="10px" alt="">

      <div class="row filaNegra4 filaRoja5"  id="N4 R5" ondragover="drop(event)" >
        <img class="img_base filaNegra4 filaRoja5">
        <img class="img_peon" id="N4" draggable='true' ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-negro.png' %}" width="40px" alt="Negro">
        <img class="img_peon" id="R5" draggable='true' ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-rojo.png' %}" width="45px" alt="Rojo">
      </div>

      <img class="img_peon" src="{% static 'img/barra.png' %}" width="370px" height="10px" alt="">

      <div class="row filaNegra5 filaRoja4"  id="N5 R4" ondragover="drop(event)" >
        <img class="img_base filaNegra5 filaRoja4">
        <img class="img_peon" id="N5" draggable='true' ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-negro.png' %}" width="40px" alt="Negro">
        <img class="img_peon" id="R4" draggable='true' ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-rojo.png' %}" width="45px" alt="Rojo">
      </div>

      <img class="img_peon" src="{% static 'img/barra.png' %}" width="370px" height="10px" alt="">

      <div class="row filaNegra6 filaRoja3"  id="N6 R3" ondragover="drop(event)" >
        <img class="img_base filaNegra5 filaRoja3">
        <img class="img_peon" id="N6" draggable='true' ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-negro.png' %}" width="40px" alt="Negro">
        <img class="img_peon" id="R3" draggable='true' ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-rojo.png' %}" width="45px" alt="Rojo">
      </div>

      <img class="img_peon" src="{% static 'img/barra.png' %}" width="370px" height="10px" alt="">

      <div class="row filaNegra7 filaRoja2"  id="N7 R2" ondragover="drop(event)" >
        <img class="img_base filaNegra7 filaRoja2">
        <img class="img_peon" id="N7" draggable='true' ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-negro.png' %}" width="40px" alt="Negro">
        <img class="img_peon" id="R2" draggable='true' ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-rojo.png' %}" width="45px" alt="Rojo">
      </div>

      <img class="img_peon" src="{% static 'img/barra.png' %}" width="370px" height="10px" alt="">

      <div class="row inicial filaNegra8 filaRoja1"  id="N8 R1" ondragover="drop(event)">
        <img class="img_base filaNegra8 filaRoja1">
        <img class="img_peon" id="R1" draggable='true'  ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-rojo.png' %}" width="45px" alt="Rojo">
        <img class="img_peon" id="R1" draggable='true'  ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-rojo.png' %}" width="45px" alt="Rojo">
        <img class="img_peon" id="R1" draggable='true'  ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-rojo.png' %}" width="45px" alt="Rojo">
        <img class="img_peon" id="R1" draggable='true'  ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-rojo.png' %}" width="45px" alt="Rojo">
        <img class="img_peon" id="R1" draggable='true'  ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-rojo.png' %}" width="45px" alt="Rojo">
        <img class="img_peon" id="R1" draggable='true'  ondragstart="dragIniciado(event)" ondragend="dragFinalizado(event)"  src="{% static 'img/peon-rojo.png' %}" width="45px" alt="Rojo">

      </div>
    </span>
  </div>

  <div class="col s5 pull-s7" style="width: 30% !important;">
    <span class="flow-text">
      <ul class="collection">
        <li class="collection-item avatar">
          <i class="material-icons circle">mood</i>
          <span class="title">Jugador Uno</span>
          <p>Movimiento: 1</p>
          <span class="title">Puntos: 8</span>

          <a href="#!" class="secondary-content"><i class="material-icons">grade</i></a>
        </li>
        <li class="collection-item avatar">
          <i class="material-icons circle">videogame_asset</i>
          <span class="title">Jugador Dos</span>
          <p>Movimiento: 1</p>
          <span class="title">Puntos: 2</span>
          <a href="#!" class="secondary-content"><i class="material-icons">grade</i></a>
        </li>
      </ul>
    </span>
  </div>
</div>
<script>
  var dragged;
  var jugadaRojo=0;
  var jugadaNegro=0;
  var boolRojo=true;
  var boolNegro=true;
  var movPeon2=0;

  function dragIniciado(event) {
    dragged = event.target;
    event.target.style.opacity = .5;
    console.log('dragIniciado')
    //console.log(event.target.id);
  }

  function dragFinalizado(event) {
    event.target.style.opacity = "";
    evaluarMovimientos();
    //aqui post
    sendDataBack(event.target);
    posicionesPeones();
    console.log('dragFinalizado')
  }

  function dragEnter(event) {
    if (event.target.className == "row") {
      event.target.style.background = "yellow";
    }
  }

  function dragLeave(event) {
    if (event.target.className == "row") {
      event.target.style.background = "";
    }
  }

  function drop(event) {
    event.preventDefault();
    if (event.target.className == "row inicial filaNegra8 filaRoja1" || event.target.className ==
      "row inicial filaNegra1 filaRoja8") {
      devolverFichas(30);

    } else if (event.target.className.includes("row")) {
      devolverFichas(6);

    } else {
      console.log('No puede tener mas de 6 peones');
    }
  }
  function evaluarMovimientos(){
    if(dragged.alt == 'Rojo' && boolRojo==true){
      jugadaRojo++;
      //console.log(jugadaRojo);
      boolNegro=false;
      boolRojo = true;
      if(jugadaRojo>=2){
        jugadaRojo=0;
        boolRojo = false;
        boolNegro=true;
      }
    }
    if(dragged.alt == 'Negro' && boolNegro==true){
      jugadaNegro++;
      boolRojo=false;
      boolNegro=true;
      if(jugadaNegro>=2){
        jugadaNegro=0;
        boolRojo = true;
        boolNegro=false;
      }
    }
  }
  function devolverFichas(limite) {

    var x = event.target.innerHTML;
    var a = event.target;
    var cont = 0;
    var fila = 0;
    var posFila = 0;
    if (dragged.alt == "Negro" && boolNegro==true && jugadaNegro<=2) {

      for (var i = 0; i < x.length; i++) {
        if (x.substring(i, i + 8) == "img_peon") {
          cont++;
        }
      }
      movPeon2=cont;

      for (var i = 0; i < x.length; i++) {
        if (x.substring(i, i + 9) == "filaNegra") {
          posFila = i;
        }
      }

      fila = x.substring(posFila + 9, posFila + 10);
      idPeon = dragged.id;
      if (cont < limite && fila >= idPeon[1]) {
        event.target.style.background = "";
        dragged.parentNode.removeChild(dragged);
        dragged.id = "N" + fila;
        event.target.appendChild(dragged);

      }
    }



    if (dragged.alt == "Rojo" && boolRojo==true && jugadaRojo<=2) {
      console.log('Rojo');

      for (var i = 0; i < x.length; i++) {
        if (x.substring(i, i + 8) == "img_peon") {
          cont++;
        }
      }
      movPeon2=cont;


      for (var i = 0; i < x.length; i++) {
        if (x.substring(i, i + 8) == "filaRoja") {
          posFila = i;
        }
      }

      fila = x.substring(posFila + 8, posFila + 9);
      idPeon = dragged.id;
      //console.log(idPeon[1]);
      if (cont < limite && fila >= idPeon[1]) {
        event.target.style.background = "";
        dragged.parentNode.removeChild(dragged);
        dragged.id = "R" + fila;

        event.target.appendChild(dragged);
      }
    }

  }

  function posicionesPeones(){
    //alert('s');
    var cont1=0;
    var cont2=0;
    var cont3=0;
    var cont4=0;
    var cont5=0;
    var cont6=0;
    var cont7=0;
    var cont8=0;
    var x =document.getElementById('N1 R8').innerHTML;
    for (var i = 0; i < x.length; i++) {
      if (x.substring(i, i + 3) == "id=") {
        //console.log('Prueba ----- '+x.substring(i+4,i+5));
        cont1++;
      }
    }
    console.log('Hay '+cont1+' peones en la fila 1');
    var x =document.getElementById('N2 R7').innerHTML;
    for (var i = 0; i < x.length; i++) {
      if (x.substring(i, i + 3) == "id=") {
        //console.log('Prueba ----- '+x.substring(i+4,i+5));
        cont2++;
      }
    }
    console.log('Hay '+cont2+' peones en la fila 2');

    var x =document.getElementById('N3 R6').innerHTML;
    for (var i = 0; i < x.length; i++) {
      if (x.substring(i, i + 3) == "id=") {
        //console.log('Prueba ----- '+x.substring(i+4,i+5));
        cont3++;
      }
    }
    console.log('Hay '+cont3+' peones en la fila 3');

    var x =document.getElementById('N4 R5').innerHTML;
    for (var i = 0; i < x.length; i++) {
      if (x.substring(i, i + 3) == "id=") {
        //console.log('Prueba ----- '+x.substring(i+4,i+5));
        cont4++;
      }
    }
    console.log('Hay '+cont4+' peones en la fila 4');


    var x =document.getElementById('N5 R4').innerHTML;
    for (var i = 0; i < x.length; i++) {
      if (x.substring(i, i + 3) == "id=") {
        //console.log('Prueba ----- '+x.substring(i+4,i+5));
        cont5++;
      }
    }
    console.log('Hay '+cont5+' peones en la fila 5');

    var x =document.getElementById('N6 R3').innerHTML;
    for (var i = 0; i < x.length; i++) {
      if (x.substring(i, i + 3) == "id=") {
        //console.log('Prueba ----- '+x.substring(i+4,i+5));
        cont6++;
      }
    }
    console.log('Hay '+cont6+' peones en la fila 6');

    var x =document.getElementById('N7 R2').innerHTML;
    for (var i = 0; i < x.length; i++) {
      if (x.substring(i, i + 3) == "id=") {
        //console.log('Prueba ----- '+x.substring(i+4,i+5));
        cont7++;
      }
    }
    console.log('Hay '+cont7+' peones en la fila 7');


    var x =document.getElementById('N8 R1').innerHTML;
    for (var i = 0; i < x.length; i++) {
      if (x.substring(i, i + 3) == "id=") {
        //console.log('Prueba ----- '+x.substring(i+4,i+5));
        cont8++;
      }
    }
    console.log('Hay '+cont8+' peones en la fila 8');
    //console.log('Ariel - '+x);
  }

  function contNegro(id){
    var contNegro=0;
    var x =document.getElementById(id).innerHTML;
    for (var i = 0; i < x.length; i++) {
      if (x.substring(i, i + 5) == 'id="N') {
        //console.log('Prueba ----- '+x.substring(i+4,i+5));
        contNegro++;
      }
    }
    return contNegro;
  }


  function contTodos(id){
    var contTodos=0;
    var x =document.getElementById(id).innerHTML;
    for (var i = 0; i < x.length; i++) {
      if (x.substring(i, i + 3) == "id=") {
        //console.log('Prueba ----- '+x.substring(i+4,i+5));
        contTodos++;
      }
    }
    return contTodos;
  }

  function contRojo(id){
    var contRojo=0;
    var x =document.getElementById(id).innerHTML;
    for (var i = 0; i < x.length; i++) {
      if (x.substring(i, i + 5) == 'id="R') {
        //console.log('Prueba ----- '+x.substring(i+4,i+5));
        contRojo++;
      }
    }
    return contRojo;
  }


  function sendDataBack(event1) {
    var cont =0;
    console.log(event1)
    var dataPeon = event1.outerHTML;
    var idPeon = '';
    // offsetParent  --> html tabla
    var tabla = event.target.offsetParent.innerHTML;

    var fila = event.target.parentElement.innerHTML;
    console.log(fila.length);
    //console.log(dataPeon.length);
    for (var i = 0; i < fila.length; i++) {
      if (fila.substring(i, i + 8) == "img_peon") {
        cont++;
      }
    }

    for (var i = 0; i < dataPeon.length; i++) {
      if (dataPeon.substring(i, i + 3) == "id=") {
        idPeon = dataPeon.substring(i+4,i+6);
      }
    }
    //console.log(idPeon);
    //console.log('Hay '+cont);

    var cont1Todos= contTodos('N1 R8');
    var cont2Todos= contTodos('N2 R7');
    var cont3Todos= contTodos('N3 R6');
    var cont4Todos= contTodos('N4 R5');
    var cont5Todos= contTodos('N5 R4');
    var cont6Todos= contTodos('N6 R3');
    var cont7Todos= contTodos('N7 R2');
    var cont8Todos= contTodos('N8 R1');


    var cont1Negro= contNegro('N1 R8');
    var cont2Negro= contNegro('N2 R7');
    var cont3Negro= contNegro('N3 R6');
    var cont4Negro= contNegro('N4 R5');
    var cont5Negro= contNegro('N5 R4');
    var cont6Negro= contNegro('N6 R3');
    var cont7Negro= contNegro('N7 R2');
    var cont8Negro= contNegro('N8 R1');


    var cont1Rojo= contRojo('N1 R8');
    var cont2Rojo= contRojo('N2 R7');
    var cont3Rojo= contRojo('N3 R6');
    var cont4Rojo= contRojo('N4 R5');
    var cont5Rojo= contRojo('N5 R4');
    var cont6Rojo= contRojo('N6 R3');
    var cont7Rojo= contRojo('N7 R2');
    var cont8Rojo= contRojo('N8 R1');


    objetoEnviar = {
      "contenidoPeon": dataPeon,
      "id": idPeon,
      "Num_Peones_Fila": cont-1,
      "tablaPeones": tabla,
      "fila1Todos":cont1Todos,
      "fila2Todos":cont2Todos,
      "fila3Todos":cont3Todos,
      "fila4Todos":cont4Todos,
      "fila5Todos":cont5Todos,
      "fila6Todos":cont6Todos,
      "fila7Todos":cont7Todos,
      "fila8Todos":cont8Todos,
      "fila1Negro":cont1Negro,
      "fila2Negro":cont2Negro,
      "fila3Negro":cont3Negro,
      "fila4Negro":cont4Negro,
      "fila5Negro":cont5Negro,
      "fila6Negro":cont6Negro,
      "fila7Negro":cont7Negro,
      "fila8Negro":cont8Negro,
      "fila1Rojo":cont1Rojo,
      "fila2Rojo":cont2Rojo,
      "fila3Rojo":cont3Rojo,
      "fila4Rojo":cont4Rojo,
      "fila5Rojo":cont5Rojo,
      "fila6Rojo":cont6Rojo,
      "fila7Rojo":cont7Rojo,
      "fila8Rojo":cont8Rojo,
    }
    $.post('/engine/', objetoEnviar, function (data, status) {

      var rta = JSON.parse(data)
      console.log('enviar datos a back', )

      if (rta['status'] == 1) {
        alert(rta['message'])
      }
    })
  }
</script>
<br>{%endblock%}
